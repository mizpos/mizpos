name: Initial Infrastructure Setup

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment"
        required: true
        default: "dev"
        type: choice
        options:
          - dev
          - prod
      confirm:
        description: "Type 'SETUP' to confirm initial setup"
        required: true
        type: string

env:
  AWS_REGION: ap-northeast-1
  LAMBROLL_VERSION: 1.3.2

permissions:
  id-token: write
  contents: read

jobs:
  validate:
    name: Validate Input
    runs-on: ubuntu-latest
    steps:
      - name: Check confirmation
        if: ${{ inputs.confirm != 'SETUP' }}
        run: |
          echo "Error: Please type 'SETUP' to confirm initial setup"
          exit 1

  setup:
    name: Initial Infrastructure Setup
    needs: validate
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set environment variables
        run: |
          if [ "${{ inputs.environment }}" == "dev" ]; then
            echo "WORKING_DIR=terraform/tf-dev" >> $GITHUB_ENV
            echo "AWS_ROLE_ARN=${{ secrets.AWS_ROLE_ARN_DEV }}" >> $GITHUB_ENV
          else
            echo "WORKING_DIR=terraform/tf-prod" >> $GITHUB_ENV
            echo "AWS_ROLE_ARN=${{ secrets.AWS_ROLE_ARN_PROD }}" >> $GITHUB_ENV
          fi

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.9.0"

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      - name: Terraform Init
        working-directory: ${{ env.WORKING_DIR }}
        run: terraform init

      - name: Terraform Validate
        working-directory: ${{ env.WORKING_DIR }}
        run: terraform validate

      - name: Terraform Plan
        working-directory: ${{ env.WORKING_DIR }}
        run: terraform plan -out=tfplan -no-color

      - name: Terraform Apply
        working-directory: ${{ env.WORKING_DIR }}
        run: terraform apply -auto-approve tfplan

      - name: Get AWS Account ID
        run: |
          AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          echo "AWS_ACCOUNT_ID=$AWS_ACCOUNT_ID" >> $GITHUB_ENV

      - name: Install Lambroll
        run: |
          curl -L https://github.com/fujiwara/lambroll/releases/download/v${{ env.LAMBROLL_VERSION }}/lambroll_v${{ env.LAMBROLL_VERSION }}_linux_amd64.tar.gz | tar -xz
          sudo mv lambroll /usr/local/bin/

      - name: Deploy Accounts Lambda
        uses: ./.github/actions/deploy-lambda
        with:
          WORKING_DIR: ${{ env.WORKING_DIR }}
          ENV: ${{ inputs.environment }}
          AWS_ACCOUNT_ID: ${{ env.AWS_ACCOUNT_ID }}
          LAMBDA_FUNTION_PATH: lambda/accounts

      - name: Deploy Stock Lambda
        uses: ./.github/actions/deploy-lambda
        with:
          WORKING_DIR: ${{ env.WORKING_DIR }}
          ENV: ${{ inputs.environment }}
          AWS_ACCOUNT_ID: ${{ env.AWS_ACCOUNT_ID }}
          LAMBDA_FUNTION_PATH: lambda/stock

      - name: Deploy Sales Lambda
        uses: ./.github/actions/deploy-lambda
        with:
          WORKING_DIR: ${{ env.WORKING_DIR }}
          ENV: ${{ inputs.environment }}
          AWS_ACCOUNT_ID: ${{ env.AWS_ACCOUNT_ID }}
          LAMBDA_FUNTION_PATH: lambda/sales

      - name: Output Infrastructure Info
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          echo "=== Initial Setup Complete ==="
          echo ""
          echo "Infrastructure outputs:"
          terraform output -json | jq -r 'to_entries[] | "\(.key): \(.value.value)"'
          echo ""
          echo "=== Next Steps ==="
          echo "1. Configure your frontend with the API Gateway URL"
          echo "2. Set up Cognito user pool for authentication"
          echo "3. Configure any additional secrets in AWS Secrets Manager"
