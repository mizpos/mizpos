name: Setup Initial Admin User

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment (dev/prod/training)"
        required: true
        default: "dev"
        type: choice
        options:
          - dev
          - prod
          - training
      email:
        description: "Admin email address"
        required: true
        type: string
      password:
        description: "Admin password (must meet Cognito requirements)"
        required: true
        type: string
      display_name:
        description: "Display name"
        required: false
        default: "管理者"
        type: string

env:
  AWS_REGION: ap-northeast-1

permissions:
  id-token: write
  contents: read

jobs:
  setup-admin:
    name: Create Admin User
    runs-on: ubuntu-slim
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ inputs.environment == 'prod' && secrets.AWS_ROLE_ARN_PROD || (inputs.environment == 'training' && secrets.AWS_ROLE_ARN_TRAINING || secrets.AWS_ROLE_ARN_DEV) }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Dependencies
        run: pip install boto3

      - name: Mask Sensitive Inputs
        run: |
          echo "::add-mask::${{ inputs.password }}"
          echo "::add-mask::${{ inputs.email }}"

      - name: Get AWS Resources
        id: aws_resources
        run: |
          # Get Cognito User Pool ID
          USER_POOL_ID=$(aws cognito-idp list-user-pools --max-results 60 --query "UserPools[?Name=='${{ inputs.environment }}-mizpos-user-pool'].Id" --output text)
          echo "user_pool_id=$USER_POOL_ID" >> $GITHUB_OUTPUT

          # DynamoDB table names follow naming convention
          USERS_TABLE="${{ inputs.environment }}-mizpos-users"
          echo "users_table=$USERS_TABLE" >> $GITHUB_OUTPUT

          ROLES_TABLE="${{ inputs.environment }}-mizpos-roles"
          echo "roles_table=$ROLES_TABLE" >> $GITHUB_OUTPUT

          echo "User Pool ID: $USER_POOL_ID"
          echo "Users Table: $USERS_TABLE"
          echo "Roles Table: $ROLES_TABLE"

      - name: Create Admin User
        env:
          ADMIN_EMAIL: ${{ inputs.email }}
          ADMIN_PASSWORD: ${{ inputs.password }}
        run: |
          python scripts/setup_admin_user.py \
            --environment "${{ inputs.environment }}" \
            --email "$ADMIN_EMAIL" \
            --password "$ADMIN_PASSWORD" \
            --display-name "${{ inputs.display_name }}" \
            --user-pool-id "${{ steps.aws_resources.outputs.user_pool_id }}" \
            --users-table "${{ steps.aws_resources.outputs.users_table }}" \
            --roles-table "${{ steps.aws_resources.outputs.roles_table }}"
