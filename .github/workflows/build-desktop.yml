name: Build Desktop App

on:
  push:
    branches: [main]
    paths:
      - "frontend/apps/mizpos-desktop/**"
      - "frontend/packages/**"
      - ".github/workflows/build-desktop.yml"
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to build for"
        required: true
        default: "dev"
        type: choice
        options:
          - dev
          - prod
  workflow_call:
    inputs:
      environment:
        description: "Environment to build for"
        required: true
        type: string

env:
  NODE_VERSION: "24"
  PNPM_VERSION: "10"
  AWS_REGION: ap-northeast-1

permissions:
  id-token: write
  contents: write

jobs:
  setup-env:
    name: Setup Environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      cdn-bucket: ${{ steps.set-env.outputs.cdn-bucket }}
      cdn-distribution-id: ${{ steps.set-env.outputs.cdn-distribution-id }}
      cdn-domain: ${{ steps.set-env.outputs.cdn-domain }}
    steps:
      - id: set-env
        run: |
          # Determine environment
          if [[ "${{ github.event_name }}" == "release" ]]; then
            ENV="prod"
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            ENV="${{ github.event.inputs.environment }}"
          else
            ENV="dev"
          fi

          echo "environment=$ENV" >> $GITHUB_OUTPUT

          # Set environment-specific values
          if [[ "$ENV" == "prod" ]]; then
            echo "cdn-bucket=prod-mizpos-cdn-assets" >> $GITHUB_OUTPUT
            echo "cdn-distribution-id=E2H6IWQATGJWQS" >> $GITHUB_OUTPUT
            echo "cdn-domain=https://di1aotrw2gywt.cloudfront.net" >> $GITHUB_OUTPUT
          else
            echo "cdn-bucket=dev-mizpos-cdn-assets" >> $GITHUB_OUTPUT
            echo "cdn-distribution-id=E195S6TD7VY00" >> $GITHUB_OUTPUT
            echo "cdn-domain=https://d1o5hbbhoeegz0.cloudfront.net" >> $GITHUB_OUTPUT
          fi

  build:
    name: Build Desktop App (${{ matrix.platform }} - ${{ needs.setup-env.outputs.environment }})
    needs: setup-env
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: windows-latest
            target: x86_64-pc-windows-msvc
            os_name: windows
            arch: x64
            artifact_ext: ".exe,.msi"
          - platform: blacksmith-2vcpu-ubuntu-2404
            target: x86_64-unknown-linux-gnu
            os_name: linux
            arch: x64
            artifact_ext: ".AppImage,.deb"
          - platform: blacksmith-2vcpu-ubuntu-2404-arm
            target: aarch64-unknown-linux-gnu
            os_name: linux
            arch: arm64
            artifact_ext: ".AppImage,.deb"
    runs-on: ${{ matrix.platform }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Frontend Environment
        uses: ./.github/actions/setup-frontend
        with:
          node-version: ${{ env.NODE_VERSION }}
          pnpm-version: ${{ env.PNPM_VERSION }}
          working-directory: frontend

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          targets: ${{ matrix.target }}

      - name: Install system dependencies (Linux)
        if: matrix.os_name == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libgtk-3-dev \
            libglib2.0-dev \
            build-essential \
            curl \
            wget \
            file \
            libxdo-dev \
            libssl-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            xdg-utils

      - name: Configure AWS Credentials for Version
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ needs.setup-env.outputs.environment == 'prod' && secrets.AWS_ROLE_ARN_PROD || secrets.AWS_ROLE_ARN_DEV }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get App Version from S3
        id: version
        shell: bash
        run: |
          chmod +x scripts/version-manager.sh
          VERSION=$(./scripts/version-manager.sh get "mizpos-desktop" "${{ needs.setup-env.outputs.environment }}")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "App version: $VERSION"

      - name: Generate API Types
        working-directory: frontend
        run: pnpm generate-api-types

      - name: Build Tauri App
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
          VITE_APP_VERSION: ${{ steps.version.outputs.version }}
          VITE_COMMIT_HASH: ${{ github.sha }}
          VITE_BUILD_TIMESTAMP: ${{ github.event.head_commit.timestamp }}
        with:
          projectPath: frontend/apps/mizpos-desktop
          includeDebug: ${{ needs.setup-env.outputs.environment == 'dev' && true || false }}
          args: ${{ needs.setup-env.outputs.environment == 'dev' && '--config src-tauri/tauri.dev.conf.json' || '' }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ needs.setup-env.outputs.environment == 'prod' && secrets.AWS_ROLE_ARN_PROD || secrets.AWS_ROLE_ARN_DEV }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Prepare and Upload to CDN
        env:
          ENV: ${{ needs.setup-env.outputs.environment }}
          CDN_BUCKET: ${{ needs.setup-env.outputs.cdn-bucket }}
        shell: bash
        run: |
          BUNDLE_DIR="frontend/apps/mizpos-desktop/src-tauri/target/release/bundle"
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)

          # Prepare files based on platform
          # Use arch suffix for Linux paths to distinguish x64 and arm64
          OS_PATH="${{ matrix.os_name }}"
          if [[ "${{ matrix.os_name }}" == "linux" ]]; then
            OS_PATH="linux-${{ matrix.arch }}"
          fi

          if [[ "${{ matrix.os_name }}" == "windows" ]]; then
            cd $BUNDLE_DIR/msi
            for file in *.msi; do
              # Upload with timestamp for history (tagged for auto-deletion after 30 days)
              aws s3 cp "$file" "s3://$CDN_BUCKET/desktop/$ENV/${OS_PATH}/mizpos-${TIMESTAMP}.msi"
              # Upload as latest (tagged to keep)
              aws s3 cp "$file" "s3://$CDN_BUCKET/desktop/$ENV/${OS_PATH}/mizpos-latest.msi"
            done
          else
            cd $BUNDLE_DIR
            # AppImage
            if [ -d "appimage" ]; then
              cd appimage
              for file in *.AppImage; do
                # Upload with timestamp for history (tagged for auto-deletion after 30 days)
                aws s3 cp "$file" "s3://$CDN_BUCKET/desktop/$ENV/${OS_PATH}/mizpos-${TIMESTAMP}.AppImage"
                # Upload as latest (tagged to keep)
                aws s3 cp "$file" "s3://$CDN_BUCKET/desktop/$ENV/${OS_PATH}/mizpos-latest.AppImage"
              done
              cd ..
            fi
            # Debian package
            if [ -d "deb" ]; then
              cd deb
              for file in *.deb; do
                # Upload with timestamp for history (tagged for auto-deletion after 30 days)
                aws s3 cp "$file" "s3://$CDN_BUCKET/desktop/$ENV/${OS_PATH}/mizpos-${TIMESTAMP}.deb"
                # Upload as latest (tagged to keep)
                aws s3 cp "$file" "s3://$CDN_BUCKET/desktop/$ENV/${OS_PATH}/mizpos-latest.deb"
              done
            fi
          fi

      - name: Upload artifacts to GitHub Release (Production only)
        if: github.event_name == 'release' && needs.setup-env.outputs.environment == 'prod'
        uses: softprops/action-gh-release@v1
        with:
          files: |
            frontend/apps/mizpos-desktop/src-tauri/target/release/bundle/**/*${{ matrix.artifact_ext }}

      - name: Generate update manifest
        if: needs.setup-env.outputs.environment == 'prod'
        run: |
          echo "Update manifest generation would go here"
          # TODO: Implement update manifest generation for Tauri updater

  increment-version:
    name: Increment Desktop Version
    needs: [setup-env, build]
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ needs.setup-env.outputs.environment == 'prod' && secrets.AWS_ROLE_ARN_PROD || secrets.AWS_ROLE_ARN_DEV }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Increment Version and Update Build Info
        run: |
          chmod +x scripts/version-manager.sh
          ENV="${{ needs.setup-env.outputs.environment }}"
          NEW_VERSION=$(./scripts/version-manager.sh increment "mizpos-desktop" "$ENV" patch)
          ./scripts/version-manager.sh set-build-info "mizpos-desktop" "$ENV" "${{ github.sha }}"
          echo "New version: $NEW_VERSION"
          echo "## Desktop App Version Updated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **New Version**: $NEW_VERSION" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: $ENV" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
