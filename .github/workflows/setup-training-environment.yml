name: Setup Training Environment

on:
  workflow_dispatch:
    inputs:
      admin_email:
        description: "Admin email address"
        required: true
        type: string
      admin_password:
        description: "Admin password (must meet Cognito requirements)"
        required: true
        type: string
      admin_display_name:
        description: "Admin display name"
        required: false
        default: "ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ç®¡ç†è€…"
        type: string
      create_seed_data:
        description: "Create seed data (events, publishers, products)"
        required: false
        default: true
        type: boolean

env:
  AWS_REGION: ap-northeast-1
  ENVIRONMENT: training

permissions:
  id-token: write
  contents: read

jobs:
  setup-training:
    name: Setup Training Environment
    runs-on: ubuntu-slim
    steps:
      - name: Generate token
        id: generate-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          repositories: mizpos-enterprise-android-manager

      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_TRAINING }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Dependencies
        run: pip install boto3

      - name: Mask Sensitive Inputs
        run: |
          echo "::add-mask::${{ inputs.admin_password }}"
          echo "::add-mask::${{ inputs.admin_email }}"

      - name: Get AWS Resources
        id: aws_resources
        run: |
          # Get Cognito User Pool ID
          USER_POOL_ID=$(aws cognito-idp list-user-pools --max-results 60 --query "UserPools[?Name=='${{ env.ENVIRONMENT }}-mizpos-user-pool'].Id" --output text)
          echo "user_pool_id=$USER_POOL_ID" >> $GITHUB_OUTPUT

          # DynamoDB table names follow naming convention
          USERS_TABLE="${{ env.ENVIRONMENT }}-mizpos-users"
          EVENTS_TABLE="${{ env.ENVIRONMENT }}-mizpos-events"
          PUBLISHERS_TABLE="${{ env.ENVIRONMENT }}-mizpos-publishers"
          STOCK_TABLE="${{ env.ENVIRONMENT }}-mizpos-stock"
          CONFIG_TABLE="${{ env.ENVIRONMENT }}-mizpos-config"

          echo "users_table=$USERS_TABLE" >> $GITHUB_OUTPUT
          echo "events_table=$EVENTS_TABLE" >> $GITHUB_OUTPUT
          echo "publishers_table=$PUBLISHERS_TABLE" >> $GITHUB_OUTPUT
          echo "stock_table=$STOCK_TABLE" >> $GITHUB_OUTPUT
          echo "config_table=$CONFIG_TABLE" >> $GITHUB_OUTPUT

          echo "User Pool ID: $USER_POOL_ID"
          echo "Users Table: $USERS_TABLE"
          echo "Events Table: $EVENTS_TABLE"
          echo "Publishers Table: $PUBLISHERS_TABLE"
          echo "Stock Table: $STOCK_TABLE"
          echo "Config Table: $CONFIG_TABLE"

      - name: Create Admin User
        env:
          ADMIN_EMAIL: ${{ inputs.admin_email }}
          ADMIN_PASSWORD: ${{ inputs.admin_password }}
        run: |
          echo "Creating admin user..."
          python scripts/setup_admin_user.py \
            --environment "${{ env.ENVIRONMENT }}" \
            --email "$ADMIN_EMAIL" \
            --password "$ADMIN_PASSWORD" \
            --display-name "${{ inputs.admin_display_name }}" \
            --user-pool-id "${{ steps.aws_resources.outputs.user_pool_id }}" \
            --users-table "${{ steps.aws_resources.outputs.users_table }}"

      - name: Create Seed Data
        if: inputs.create_seed_data == true
        run: |
          echo "Creating seed data..."
          python scripts/seed_training_data.py \
            --environment "${{ env.ENVIRONMENT }}" \
            --events-table "${{ steps.aws_resources.outputs.events_table }}" \
            --publishers-table "${{ steps.aws_resources.outputs.publishers_table }}" \
            --stock-table "${{ steps.aws_resources.outputs.stock_table }}" \
            --config-table "${{ steps.aws_resources.outputs.config_table }}" \
            --region "${{ env.AWS_REGION }}"

      - name: Setup Summary
        run: |
          echo "## Training Environment Setup Complete! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Admin User" >> $GITHUB_STEP_SUMMARY
          echo "- **Email**: \`${{ inputs.admin_email }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Display Name**: ${{ inputs.admin_display_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Resources" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ env.ENVIRONMENT }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Cognito User Pool**: ${{ steps.aws_resources.outputs.user_pool_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Users Table**: ${{ steps.aws_resources.outputs.users_table }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.create_seed_data }}" == "true" ]; then
            echo "### Seed Data" >> $GITHUB_STEP_SUMMARY
            echo "âœ“ Events created" >> $GITHUB_STEP_SUMMARY
            echo "âœ“ Publishers created" >> $GITHUB_STEP_SUMMARY
            echo "âœ“ Products created" >> $GITHUB_STEP_SUMMARY
            echo "âœ“ Shipping options created" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "Completed at: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
